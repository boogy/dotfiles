#compdef run-tg

# Zsh completion script for run-tg
# Supports all CLI options with parameter completions where applicable
#
# Installation:
#   Option 1: Add bin/run-tg/ to your fpath in .zshrc BEFORE compinit:
#     fpath=(/path/to/nx-aws-accounts/bin/run-tg $fpath)
#     autoload -Uz compinit && compinit
#
#   Option 2: Copy this file to a directory already in your fpath:
#     cp _run-tg ~/.zsh/completions/
#
# After installation, restart your shell or run: exec zsh
#
# Required: Set RUN_TG_REPO_DIR environment variable to the repository root
# This is automatically set by .envrc when using direnv

# Get base directory for completions
_run_tg_base_dir() {
    if [[ -n "$RUN_TG_REPO_DIR" && -d "$RUN_TG_REPO_DIR/live" ]]; then
        echo "$RUN_TG_REPO_DIR"
    elif [[ -d "${PWD}/live/accounts" ]]; then
        echo "$PWD"
    else
        local git_root
        git_root=$(git rev-parse --show-toplevel 2>/dev/null)
        if [[ -n "$git_root" && -d "$git_root/live/accounts" ]]; then
            echo "$git_root"
        fi
    fi
}

# Complete account names
_run_tg_accounts() {
    local base_dir="$(_run_tg_base_dir)"
    if [[ -n "$base_dir" && -d "$base_dir/live/accounts" ]]; then
        local -a accounts
        accounts=(${(f)"$(ls -1 "$base_dir/live/accounts" 2>/dev/null)"})
        compadd -a accounts
    fi
}

# Complete module names
_run_tg_modules() {
    local base_dir="$(_run_tg_base_dir)"
    if [[ -n "$base_dir" && -d "$base_dir/modules" ]]; then
        local -a modules
        modules=(${(f)"$(ls -1 "$base_dir/modules" 2>/dev/null)"})
        compadd -a modules
    fi
}

# Complete resource names - uses --account value if provided
_run_tg_resources() {
    local base_dir="$(_run_tg_base_dir)"
    [[ -z "$base_dir" ]] && return

    local -a resources
    local account_value=""

    # Try to get the account value from already parsed arguments
    # Check both -a and --account forms
    if [[ -n "${opt_args[-a]}" ]]; then
        account_value="${opt_args[-a]}"
    elif [[ -n "${opt_args[--account]}" ]]; then
        account_value="${opt_args[--account]}"
    fi

    if [[ -n "$account_value" && -d "$base_dir/live/accounts/$account_value" ]]; then
        # List resources for the specific account
        resources=(${(f)"$(ls -1 "$base_dir/live/accounts/$account_value" 2>/dev/null)"})
    else
        # No account specified or invalid - list all unique resources across all accounts
        resources=(${(f)"$(find "$base_dir/live/accounts" -mindepth 2 -maxdepth 2 -type d -exec basename {} \; 2>/dev/null | sort -u)"})
    fi

    compadd -a resources
}

_run_tg() {
    local curcontext="$curcontext" state line
    typeset -A opt_args

    _arguments -C \
        '(-a --account)'{-a,--account}'[Regex pattern to match account folder names]:account pattern:_run_tg_accounts' \
        '(-r --resource)'{-r,--resource}'[Regex pattern to match resource folder names]:resource pattern:_run_tg_resources' \
        '(-m --module)'{-m,--module}'[Search for terragrunt.hcl files containing this terraform module name]:module name:_run_tg_modules' \
        '(-g --grep)'{-g,--grep}'[Search for text content in terragrunt.hcl, *.tf, *.tfvars files]:grep pattern:' \
        '(-b --base-dir)'{-b,--base-dir}'[Base directory containing account folders]:directory:_files -/' \
        '--run-all[Run terragrunt run-all command across matched resource folders]' \
        '(-p --parallelism)'{-p,--parallelism}'[Number of parallel jobs for run-all]:parallelism:(1 2 4 5 8 10 16 20 32)' \
        '(-l --list)'{-l,--list}'[List the folders that would be processed without executing any commands]' \
        '(-v --verbose)'{-v,--verbose}'[Show the full command being executed and all output in real-time]' \
        '(-L --limit)'{-L,--limit}'[Limit processing to the first N matching folders]:limit:(1 2 3 5 10 20 50 100)' \
        '(-i --interactive)'{-i,--interactive}'[Interactively select which folders to process from the matched list]' \
        '(-I --interactive-apply)'{-I,--interactive-apply}'[Allow interactive confirmation for apply/destroy commands]' \
        '(-j --json-log)'{-j,--json-log}'[Enable structured JSON logging output from Terragrunt]' \
        '(-em --exclude-module)'{-em,--exclude-module}'[Regex pattern to exclude folders by module name]:exclude module pattern:_run_tg_resources' \
        '(-ea --exclude-account)'{-ea,--exclude-account}'[Regex pattern to exclude folders by account name]:exclude account pattern:_run_tg_accounts' \
        '(-f --fail-fast)'{-f,--fail-fast}'[Stop execution on first failure (only works without --run-all)]' \
        '(-R --retries)'{-R,--retries}'[Number of retries for failed commands (only works without --run-all)]:retries:(0 1 2 3 5)' \
        '(-n --dry-run)'{-n,--dry-run}'[Show what commands would be executed without actually running them]' \
        '--changed-files[Only process folders with changed terragrunt.hcl files (git diff)]' \
        '--git-base[Base branch for git diff comparison]:branch:(main master origin/main origin/master)' \
        '--validate[Run terragrunt validate-inputs before executing action]' \
        '--summary[Show summary statistics about matched folders]' \
        '(-h --help)'{-h,--help}'[Show help message]' \
        '1:action:(plan init apply destroy)'
}

_run_tg "$@"
