#compdef iam-validator
# Zsh completion for iam-validator
# Generated by: iam-validator completion zsh

_iam_validator() {
    local curcontext="$curcontext" state line
    typeset -A opt_args

    # Cached AWS services
    local -a aws_services
    aws_services=('acm' 'apigateway' 'athena' 'autoscaling' 'backup' 'batch' 'bedrock' 'cloudformation' 'cloudfront' 'cloudtrail' 'cloudwatch' 'cognito-idp' 'config' 'dynamodb' 'ec2' 'ec2-instance-connect' 'ecr' 'ecs' 'eks' 'elasticache' 'elasticfilesystem' 'elasticloadbalancing' 'es' 'events' 'firehose' 'glacier' 'glue' 'guardduty' 'iam' 'imagebuilder' 'inspector2' 'kinesis' 'kms' 'lambda' 'logs' 'rds' 'route53' 's3' 'scheduler' 'secretsmanager' 'securityhub' 'sns' 'sqs' 'states' 'sts' 'support' 'waf' 'wafv2')

    _arguments -C \
        '1: :_iam_validator_commands' \
        '*::arg:->args'

    case $state in
        args)
            case $words[1] in
                query)
                    local query_state
                    _arguments -C \
                        '1: :_iam_validator_query_subcommands' \
                        '*::arg:->query_args' && return 0

                    case $state in
                        query_args)
                            case $words[1] in
                                action)
                                    _arguments \
                                        '--service[AWS service name]:service:($aws_services)' \
                                        '--name[Action name]:action name:' \
                                        '--access-level[Filter by access level]:access level:(read write list tagging permissions-management)' \
                                        '--resource-type[Filter by resource type]:resource type:' \
                                        '--condition[Filter by condition key]:condition key:' \
                                        '--output[Output format]:format:(json yaml text)'
                                    ;;
                                arn)
                                    _arguments \
                                        '--service[AWS service name]:service:($aws_services)' \
                                        '--name[ARN resource type]:arn type:' \
                                        '--list-arn-types[List all ARN types]' \
                                        '--output[Output format]:format:(json yaml text)'
                                    ;;
                                condition)
                                    _arguments \
                                        '--service[AWS service name]:service:($aws_services)' \
                                        '--name[Condition key name]:condition key:' \
                                        '--output[Output format]:format:(json yaml text)'
                                    ;;
                            esac
                            ;;
                    esac
                    ;;
                validate)
                    _arguments \
                        '*--path[Path to policy file or directory]:file:_files' \
                        '*-p[Path to policy file or directory]:file:_files' \
                        '--stdin[Read policy from stdin]' \
                        '(--format -f)'{--format,-f}'[Output format]:format:(console enhanced json markdown html csv sarif)' \
                        '(--output -o)'{--output,-o}'[Output file path]:file:_files' \
                        '--no-recursive[Do not recursively search directories]' \
                        '--fail-on-warnings[Fail validation if warnings are found]' \
                        '(--policy-type -t)'{--policy-type,-t}'[Type of IAM policy]:policy type:(IDENTITY_POLICY RESOURCE_POLICY TRUST_POLICY SERVICE_CONTROL_POLICY RESOURCE_CONTROL_POLICY)' \
                        '--github-comment[Post summary comment to PR]' \
                        '--github-review[Create line-specific review comments]' \
                        '--github-summary[Write to GitHub Actions job summary]' \
                        '(--verbose -v)'{--verbose,-v}'[Enable verbose logging]' \
                        '(--config -c)'{--config,-c}'[Configuration file]:file:_files' \
                        '--custom-checks-dir[Custom checks directory]:directory:_directories' \
                        '--aws-services-dir[AWS service definitions directory]:directory:_directories' \
                        '--stream[Process files one-by-one]' \
                        '--batch-size[Policies per batch]:number:' \
                        '--summary[Show Executive Summary section]' \
                        '--severity-breakdown[Show Issue Severity Breakdown section]' \
                        '--allow-owner-ignore[Allow CODEOWNERS to ignore findings]' \
                        '--no-owner-ignore[Disable CODEOWNERS ignore feature]' \
                        '--ci[CI mode - print enhanced output, write JSON to file]' \
                        '--ci-output[Output file for JSON report in CI mode]:file:_files'
                    ;;
                post-to-pr)
                    _arguments \
                        '(--report -r)'{--report,-r}'[Path to JSON report file]:file:_files' \
                        '--create-review[Create line-specific review comments]' \
                        '--no-review[Do not create line-specific review comments]' \
                        '--add-summary[Add summary comment]' \
                        '--no-summary[Do not add summary comment]' \
                        '(--config -c)'{--config,-c}'[Configuration file]:file:_files'
                    ;;
                analyze)
                    _arguments \
                        '*--path[Path to policy file or directory]:file:_files' \
                        '*-p[Path to policy file or directory]:file:_files' \
                        '(--policy-type -t)'{--policy-type,-t}'[Type of IAM policy]:policy type:(IDENTITY_POLICY RESOURCE_POLICY SERVICE_CONTROL_POLICY)' \
                        '--region[AWS region]:region:' \
                        '--profile[AWS profile]:profile:' \
                        '(--format -f)'{--format,-f}'[Output format]:format:(console json markdown)' \
                        '(--output -o)'{--output,-o}'[Output file path]:file:_files' \
                        '--no-recursive[Do not recursively search directories]' \
                        '--fail-on-warnings[Fail validation if warnings are found]' \
                        '--github-comment[Post validation results as GitHub PR comment]' \
                        '--github-review[Create line-specific review comments on PR]' \
                        '--github-summary[Write validation summary to GitHub Actions job summary]' \
                        '--run-all-checks[Run full validation checks if Access Analyzer passes]' \
                        '*--check-access-not-granted[Actions to check are NOT granted]:action:' \
                        '*--check-access-resources[Resources to check]:resource:' \
                        '--check-no-new-access[Path to existing policy]:file:_files' \
                        '--check-no-public-access[Check that resource policy does not allow public access]' \
                        '*--public-access-resource-type[Resource type for public access check]:resource type:' \
                        '(--verbose -v)'{--verbose,-v}'[Enable verbose logging]'
                    ;;
                cache)
                    _arguments \
                        '1: :(info list clear refresh prefetch location)'
                    ;;
                sync-services)
                    _arguments \
                        '--output-dir[Output directory]:directory:_directories' \
                        '--max-concurrent[Maximum concurrent downloads]:number:'
                    ;;
                completion)
                    _arguments \
                        '1: :(bash zsh)'
                    ;;
            esac
            ;;
    esac
}

_iam_validator_commands() {
    local -a commands
    commands=(
        'validate:Validate IAM policies'
        'post-to-pr:Post validation results to GitHub PR'
        'analyze:Analyze IAM policies using AWS IAM Access Analyzer'
        'cache:Manage AWS service definition cache'
        'sync-services:Sync/download all AWS service definitions for offline use'
        'query:Query AWS service definitions (actions, ARNs, condition keys)'
        'completion:Generate shell completion scripts (bash or zsh)'
    )
    _describe 'command' commands
}

_iam_validator_query_subcommands() {
    local -a subcommands
    subcommands=(
        'action:Query IAM actions'
        'arn:Query ARN formats'
        'condition:Query condition keys'
    )
    _describe 'query subcommand' subcommands
}

_iam_validator "$@"

